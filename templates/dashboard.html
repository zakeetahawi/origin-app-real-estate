{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard - Origin App{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border-radius: 15px;
        border: none;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
    }
    .stat-icon {
        font-size: 2.5rem;
        opacity: 0.3;
    }
    .badge-pulse {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    .alert-card {
        border-left: 4px solid;
        border-radius: 8px;
    }
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Welcome Banner -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white py-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-2">
                                <i class="fas fa-chart-line me-2"></i>
                                Welcome back, {{ user.get_full_name|default:user.username }}!
                            </h2>
                            <p class="mb-0 opacity-75">Here's what's happening with your real estate portfolio today.</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <h4 class="mb-0">{{ today|date:"l, F d, Y" }}</h4>
                            <p class="mb-0 opacity-75">
                                <i class="fas fa-clock me-1"></i>
                                Real-time Data
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Performance Indicators -->
    <div class="row g-4 mb-4">
        <!-- Total Properties -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <p class="text-white-50 mb-1 small text-uppercase">Total Properties</p>
                            <h2 class="mb-0 fw-bold">{{ total_properties|default:0 }}</h2>
                            <small class="opacity-75">
                                <i class="fas fa-check-circle"></i> {{ available_properties }} Available
                            </small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-building"></i>
                        </div>
                    </div>
                    <div class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
                        <div class="progress-bar bg-white" style="width: {{ occupancy_rate }}%"></div>
                    </div>
                    <small class="opacity-75 mt-2 d-block">{{ occupancy_rate }}% Occupancy Rate</small>
                </div>
            </div>
        </div>

        <!-- Active Contracts -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <p class="text-white-50 mb-1 small text-uppercase">Active Contracts</p>
                            <h2 class="mb-0 fw-bold">{{ active_contracts|default:0 }}</h2>
                            <small class="opacity-75">
                                <i class="fas fa-exclamation-triangle"></i> {{ expiring_soon }} Expiring Soon
                            </small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-file-contract"></i>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="opacity-75">of {{ total_contracts }} Total</small>
                        <a href="{% url 'contracts:list' %}" class="btn btn-sm btn-light text-danger">
                            View <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue This Month -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card shadow-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <p class="text-white-50 mb-1 small text-uppercase">Revenue This Month</p>
                            <h2 class="mb-0 fw-bold">EGP {{ payments_month|floatformat:0|default:"0" }}</h2>
                            <small class="opacity-75">
                                <i class="fas fa-arrow-up"></i> Monthly Income
                            </small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="opacity-75">Total: EGP {{ total_revenue|floatformat:0 }}</small>
                        <a href="{% url 'financial:dashboard' %}" class="btn btn-sm btn-light text-info">
                            View <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance Requests -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card shadow-sm" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <p class="text-white-50 mb-1 small text-uppercase">Maintenance</p>
                            <h2 class="mb-0 fw-bold">{{ pending_maintenance|default:0 }}</h2>
                            <small class="opacity-75">
                                {% if urgent_maintenance > 0 %}
                                <span class="badge bg-danger badge-pulse">{{ urgent_maintenance }} Urgent</span>
                                {% else %}
                                <i class="fas fa-check"></i> No Urgent
                                {% endif %}
                            </small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="opacity-75">{{ in_progress_maintenance }} In Progress</small>
                        <a href="{% url 'maintenance:list' %}" class="btn btn-sm btn-light text-warning">
                            View <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Stats Row -->
    <div class="row g-4 mb-4">
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm text-center h-100">
                <div class="card-body">
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex p-3 mb-2">
                        <i class="fas fa-users text-success fa-2x"></i>
                    </div>
                    <h4 class="mb-0 fw-bold">{{ total_clients }}</h4>
                    <small class="text-muted">Clients</small>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm text-center h-100">
                <div class="card-body">
                    <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex p-3 mb-2">
                        <i class="fas fa-user-tie text-warning fa-2x"></i>
                    </div>
                    <h4 class="mb-0 fw-bold">{{ total_owners }}</h4>
                    <small class="text-muted">Owners</small>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm text-center h-100">
                <div class="card-body">
                    <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex p-3 mb-2">
                        <i class="fas fa-handshake text-info fa-2x"></i>
                    </div>
                    <h4 class="mb-0 fw-bold">{{ active_sales }}</h4>
                    <small class="text-muted">Active Sales</small>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm text-center h-100">
                <div class="card-body">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex p-3 mb-2">
                        <i class="fas fa-bookmark text-primary fa-2x"></i>
                    </div>
                    <h4 class="mb-0 fw-bold">{{ pending_reservations }}</h4>
                    <small class="text-muted">Reservations</small>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm text-center h-100">
                <div class="card-body">
                    <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex p-3 mb-2">
                        <i class="fas fa-wrench text-danger fa-2x"></i>
                    </div>
                    <h4 class="mb-0 fw-bold">{{ under_maintenance }}</h4>
                    <small class="text-muted">Maintenance</small>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm text-center h-100">
                <div class="card-body">
                    <div class="bg-secondary bg-opacity-10 rounded-circle d-inline-flex p-3 mb-2">
                        <i class="fas fa-plus-circle text-secondary fa-2x"></i>
                    </div>
                    <h4 class="mb-0 fw-bold">{{ new_contracts_month }}</h4>
                    <small class="text-muted">New Contracts</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Revenue Trend -->
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line text-primary me-2"></i>
                            Revenue Trend (Last 6 Months)
                        </h5>
                        <span class="badge bg-success">
                            <i class="fas fa-arrow-up"></i> Growing
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="revenueTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Distribution -->
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-success me-2"></i>
                        Properties by Type
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="propertyTypesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts & Recent Activities -->
    <div class="row g-4 mb-4">
        <!-- Contracts Expiring Soon -->
        {% if contracts_expiring_7days %}
        <div class="col-xl-6">
            <div class="card border-0 shadow-sm alert-card border-warning">
                <div class="card-header bg-warning bg-opacity-10 border-0">
                    <h5 class="mb-0 text-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Contracts Expiring in 7 Days
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for contract in contracts_expiring_7days %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        <a href="{% url 'contracts:detail' contract.pk %}" class="text-decoration-none">
                                            {{ contract.property.title|truncatewords:5 }}
                                        </a>
                                    </h6>
                                    <small class="text-muted">
                                        Client: {{ contract.client.name }} | 
                                        Expires: {{ contract.end_date|date:"M d, Y" }}
                                    </small>
                                </div>
                                <span class="badge bg-warning">
                                    {{ contract.end_date|timeuntil }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recent Contracts -->
        <div class="col-xl-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-file-contract text-success me-2"></i>
                            Recent Contracts
                        </h5>
                        <a href="{% url 'contracts:list' %}" class="btn btn-sm btn-outline-success">
                            View All
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if recent_contracts %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Property</th>
                                    <th>Client</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contract in recent_contracts %}
                                <tr>
                                    <td>
                                        <a href="{% url 'contracts:detail' contract.pk %}" class="text-decoration-none fw-bold">
                                            {{ contract.property.code }}
                                        </a>
                                    </td>
                                    <td>{{ contract.client.name|truncatewords:2 }}</td>
                                    <td class="text-success fw-bold">EGP {{ contract.rent_amount|floatformat:0 }}</td>
                                    <td>
                                        {% if contract.status == 'active' %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ contract.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ contract.start_date|date:"M d" }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i>
                        <p class="mb-0">No contracts yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Maintenance & Payments -->
    <div class="row g-4 mb-4">
        <!-- Recent Maintenance -->
        <div class="col-xl-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-tools text-warning me-2"></i>
                            Recent Maintenance
                        </h5>
                        <a href="{% url 'maintenance:list' %}" class="btn btn-sm btn-outline-warning">
                            View All
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if recent_maintenance %}
                    <div class="list-group list-group-flush">
                        {% for maint in recent_maintenance %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <a href="{% url 'maintenance:detail' maint.pk %}" class="text-decoration-none">
                                            {{ maint.title|truncatewords:5 }}
                                        </a>
                                    </h6>
                                    <small class="text-muted">
                                        {{ maint.property.code }} | {{ maint.request_date|date:"M d, Y" }}
                                    </small>
                                </div>
                                <div class="text-end ms-3">
                                    {% if maint.priority == 'urgent' %}
                                    <span class="badge bg-danger mb-1">Urgent</span>
                                    {% elif maint.priority == 'high' %}
                                    <span class="badge bg-warning mb-1">High</span>
                                    {% else %}
                                    <span class="badge bg-secondary mb-1">{{ maint.get_priority_display }}</span>
                                    {% endif %}
                                    <br>
                                    {% if maint.status == 'completed' %}
                                    <span class="badge bg-success">Completed</span>
                                    {% elif maint.status == 'in_progress' %}
                                    <span class="badge bg-info">In Progress</span>
                                    {% else %}
                                    <span class="badge bg-danger">Pending</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i>
                        <p class="mb-0">No maintenance requests</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Payments -->
        <div class="col-xl-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-money-check-alt text-success me-2"></i>
                            Recent Payments
                        </h5>
                        <a href="{% url 'financial:dashboard' %}" class="btn btn-sm btn-outline-success">
                            View All
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if recent_payments %}
                    <div class="list-group list-group-flush">
                        {% for payment in recent_payments %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ payment.payment_number }}</h6>
                                    <small class="text-muted">
                                        {{ payment.payment_method|title }} | {{ payment.payment_date|date:"M d, Y" }}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <h5 class="mb-0 text-success">EGP {{ payment.amount|floatformat:0 }}</h5>
                                    <span class="badge bg-success">Paid</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i>
                        <p class="mb-0">No recent payments</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt text-warning me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-2 col-md-4 col-6">
                            <a href="{% url 'properties:create' %}" class="btn btn-outline-primary w-100 py-3">
                                <i class="fas fa-plus-circle d-block mb-2 fa-2x"></i>
                                Add Property
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6">
                            <a href="{% url 'contracts:create' %}" class="btn btn-outline-success w-100 py-3">
                                <i class="fas fa-file-signature d-block mb-2 fa-2x"></i>
                                New Contract
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6">
                            <a href="{% url 'clients:create' %}" class="btn btn-outline-info w-100 py-3">
                                <i class="fas fa-user-plus d-block mb-2 fa-2x"></i>
                                Add Client
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6">
                            <a href="{% url 'maintenance:create' %}" class="btn btn-outline-warning w-100 py-3">
                                <i class="fas fa-wrench d-block mb-2 fa-2x"></i>
                                Maintenance
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6">
                            <a href="{% url 'sales:dashboard' %}" class="btn btn-outline-danger w-100 py-3">
                                <i class="fas fa-handshake d-block mb-2 fa-2x"></i>
                                Sales
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6">
                            <a href="{% url 'financial:dashboard' %}" class="btn btn-outline-dark w-100 py-3">
                                <i class="fas fa-chart-line d-block mb-2 fa-2x"></i>
                                Reports
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Revenue Trend Chart
const revenueTrendCtx = document.getElementById('revenueTrendChart');
new Chart(revenueTrendCtx, {
    type: 'line',
    data: {
        labels: {{ revenue_trend_labels|safe }},
        datasets: [{
            label: 'Revenue (EGP)',
            data: {{ revenue_trend_data|safe }},
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointBackgroundColor: '#fff',
            pointBorderColor: 'rgba(102, 126, 234, 1)',
            pointBorderWidth: 3,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                    size: 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 13
                },
                callbacks: {
                    label: function(context) {
                        return 'EGP ' + context.parsed.y.toLocaleString();
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'EGP ' + value.toLocaleString();
                    }
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Property Types Chart
const propertyTypesCtx = document.getElementById('propertyTypesChart');
new Chart(propertyTypesCtx, {
    type: 'doughnut',
    data: {
        labels: {{ chart_property_types_labels|safe }},
        datasets: [{
            data: {{ chart_property_types_data|safe }},
            backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(118, 75, 162, 0.8)',
                'rgba(237, 100, 166, 0.8)',
                'rgba(245, 87, 108, 0.8)',
                'rgba(67, 233, 123, 0.8)',
                'rgba(252, 163, 17, 0.8)',
            ],
            borderWidth: 3,
            borderColor: '#fff',
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed + ' properties';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
